terraform {
  required_version = ">= 1.6.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.6"
    }
  }
}

provider "aws" {
  region = "us-east-1"
}

# Generate a random suffix for the bucket name
resource "random_id" "suffix" {
  byte_length = 3
}

locals {
  bucket_name = "jayla-static-site-${random_id.suffix.hex}"
}

# 1Ô∏è Create the S3 bucket
resource "aws_s3_bucket" "site" {
  bucket = local.bucket_name
  tags = {
    Project = "S3 Static Website"
    Owner   = "Jayla"
  }
}

# 2Ô∏è Allow public website access
resource "aws_s3_bucket_public_access_block" "allow_public" {
  bucket                  = aws_s3_bucket.site.id
  block_public_acls       = false
  block_public_policy     = false
  ignore_public_acls      = false
  restrict_public_buckets = false
}

# 3Ô∏èBucket policy to make files publicly readable
resource "aws_s3_bucket_policy" "public_read" {
  bucket = aws_s3_bucket.site.id
  policy = jsonencode({
    Version = "2012-10-17",
    Statement = [{
      Sid       = "PublicReadForWebsite"
      Effect    = "Allow"
      Principal = "*"
      Action    = ["s3:GetObject"]
      Resource  = ["${aws_s3_bucket.site.arn}/*"]
    }]
  })
  depends_on = [aws_s3_bucket_public_access_block.allow_public]
}

# 4Ô∏è Configure S3 website (index + error pages)
resource "aws_s3_bucket_website_configuration" "website" {
  bucket = aws_s3_bucket.site.id
  index_document {
    suffix = "index.html"
  }
  error_document {
    key = "404.html"
  }
}

# 5Ô∏è Upload simple website files
resource "aws_s3_object" "index" {
  bucket       = aws_s3_bucket.site.id
  key          = "index.html"
  content_type = "text/html"
  content = <<HTML
<!doctype html>
<html>
  <head><meta charset="utf-8"><title>Jayla's AWS Website</title></head>
  <body style="font-family:sans-serif;max-width:720px;margin:40px auto;text-align:center;">
    <h1> Hello from S3 Static Website!</h1>
    <p>Deployed using <strong>Terraform</strong> on Jayla‚Äôs new AWS account üå©Ô∏è</p>
  </body>
</html>
HTML
}

resource "aws_s3_object" "error" {
  bucket       = aws_s3_bucket.site.id
  key          = "404.html"
  content_type = "text/html"
  content = <<HTML
<!doctype html>
<html>
  <head><meta charset="utf-8"><title>404 - Not Found</title></head>
  <body style="font-family:sans-serif;max-width:720px;margin:40px auto;text-align:center;">
    <h1> Page Not Found</h1>
    <p>Oops! Try going back to the homepage.</p>
  </body>
</html>
HTML
}

# 6Ô∏è Outputs
output "bucket_name" {
  value = aws_s3_bucket.site.bucket
}

output "website_url" {
  value = aws_s3_bucket_website_configuration.website.website_endpoint
}


